[gcode_shell_command generate_shaper]
command: sh /home/biqu/klipper/LHS_Tools/ResHelper/gen.sh # If your user is not home/pi, then change this path to match that
timeout: 320.
verbose: True


[gcode_macro RESONANCE_TEST_X]
gcode:
  {%set aphz = params.APHZ | default(printer.configfile.settings.resonance_tester.accel_per_hz) | int %}
  {%set dr = params.DAMPING_RATIO | default(0) | int %}
  {%set ns = params.FAST | default(1) | int %}
  RESHELPER AXIS=x ACCEL_PER_HZ={aphz} DR={dr} FAST={ns}


[gcode_macro RESONANCE_TEST_Y]
gcode:
  {%set aphz = params.APHZ | default(printer.configfile.settings.resonance_tester.accel_per_hz) | int %}
  {%set dr = params.DAMPING_RATIO | default(0) | int %}
  {%set ns = params.FAST | default(1) | int %}
  RESHELPER AXIS=y ACCEL_PER_HZ={aphz} DR={dr} FAST={ns}


[gcode_macro RESHELPER]
gcode:
  {%set aphz = params.ACCEL_PER_HZ | default(printer.configfile.settings.resonance_tester.accel_per_hz) | int %}
  {%set axis = params.AXIS | default('x') | string %} 
  {%set dr = params.DR | default(0) | int %}
  {%set ns = params.FAST | default(1) | int %}
  RESPOND MSG='Starting ResHelper Resonance Testing' 
  RESPOND MSG='Calculate Damping Ratio: {"OFF" if dr==0 else "ON"}'
  RESPOND MSG='Skip Smooth Shaper Calculations: {"OFF" if ns==0 else "ON"}'
  RESPOND MSG='Accel per hz = {aphz}' 
  TEST_RESONANCES {rawparams}
  RUN_SHELL_COMMAND cmd=generate_shaper PARAMS='{axis} {dr} {ns}'
  